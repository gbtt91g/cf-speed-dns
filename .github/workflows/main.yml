name: IP Auto-Processor

on:
  push:
    paths:
      - 'ipTop10.html'  # 精确路径匹配，注意大小写敏感

jobs:
  ip-crawler:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 必须开启写权限

    steps:
      # 阶段1：代码获取（无Pages痕迹）
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          # 禁用所有Pages相关参数
          persist-credentials: false
          clean: true

      # 阶段2：IP提取（军用级正则）
      - name: Extract Military-grade IPs
        run: |
          # 超严格IP匹配模式（排除所有异常字符）
          grep -Po '\b(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3}\b' ipTop10.html \
          | awk '!x[$0]++' > cfip.txt  # 内存哈希去重

      # 阶段3：安全提交（无第三方依赖）
      - name: Secure Commit
        run: |
          # 强制重置用户配置
          git config --global --unset-all http.https://github.com/.extraheader || true

          # 原子级提交检测
          if [ -n "$(git status --porcelain cfip.txt)" ]; then
            git add cfip.txt
            git -c user.name="CyberSec Bot" -c user.email="[email protected]" \
              commit -m "IP数据库战备更新 $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin HEAD:${{ github.ref }}
          else
            echo "情报无变化，终止行动"
          fi
